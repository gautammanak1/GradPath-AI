const W=(e,n)=>n.some(t=>e instanceof t);let L,$;function x(){return L||(L=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function k(){return $||($=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const T=new WeakMap,w=new WeakMap,j=new WeakMap,h=new WeakMap,E=new WeakMap;function F(e){const n=new Promise((t,o)=>{const i=()=>{e.removeEventListener("success",c),e.removeEventListener("error",r)},c=()=>{t(u(e.result)),i()},r=()=>{o(e.error),i()};e.addEventListener("success",c),e.addEventListener("error",r)});return n.then(t=>{t instanceof IDBCursor&&T.set(t,e)}).catch(()=>{}),E.set(n,e),n}function N(e){if(w.has(e))return;const n=new Promise((t,o)=>{const i=()=>{e.removeEventListener("complete",c),e.removeEventListener("error",r),e.removeEventListener("abort",r)},c=()=>{t(),i()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",c),e.addEventListener("error",r),e.addEventListener("abort",r)});w.set(e,n)}let B={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return w.get(e);if(n==="objectStoreNames")return e.objectStoreNames||j.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return u(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function O(e){B=e(B)}function K(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(n,...t){const o=e.call(D(this),n,...t);return j.set(o,n.sort?n.sort():[n]),u(o)}:k().includes(e)?function(...n){return e.apply(D(this),n),u(T.get(this))}:function(...n){return u(e.apply(D(this),n))}}function R(e){return typeof e=="function"?K(e):(e instanceof IDBTransaction&&N(e),W(e,x())?new Proxy(e,B):e)}function u(e){if(e instanceof IDBRequest)return F(e);if(h.has(e))return h.get(e);const n=R(e);return n!==e&&(h.set(e,n),E.set(n,e)),n}const D=e=>E.get(e);function ee(e,n,{blocked:t,upgrade:o,blocking:i,terminated:c}={}){const r=indexedDB.open(e,n),d=u(r);return o&&r.addEventListener("upgradeneeded",s=>{o(u(r.result),s.oldVersion,s.newVersion,u(r.transaction),s)}),t&&r.addEventListener("blocked",s=>t(s.oldVersion,s.newVersion,s)),d.then(s=>{c&&s.addEventListener("close",()=>c()),i&&s.addEventListener("versionchange",a=>i(a.oldVersion,a.newVersion,a))}).catch(()=>{}),d}const v=["get","getKey","getAll","getAllKeys","count"],z=["put","add","delete","clear"],m=new Map;function g(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(m.get(n))return m.get(n);const t=n.replace(/FromIndex$/,""),o=n!==t,i=z.includes(t);if(!(t in(o?IDBIndex:IDBObjectStore).prototype)||!(i||v.includes(t)))return;const c=async function(r,...d){const s=this.transaction(r,i?"readwrite":"readonly");let a=s.store;return o&&(a=a.index(d.shift())),(await Promise.all([a[t](...d),i&&s.done]))[0]};return m.set(n,c),c}O(e=>({...e,get:(n,t,o)=>g(n,t)||e.get(n,t,o),has:(n,t)=>!!g(n,t)||e.has(n,t)}));const G=(e,n)=>n.some(t=>e instanceof t);let P,C;function H(){return P||(P=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function J(){return C||(C=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const V=new WeakMap,b=new WeakMap,A=new WeakMap,y=new WeakMap,M=new WeakMap;function Q(e){const n=new Promise((t,o)=>{const i=()=>{e.removeEventListener("success",c),e.removeEventListener("error",r)},c=()=>{t(f(e.result)),i()},r=()=>{o(e.error),i()};e.addEventListener("success",c),e.addEventListener("error",r)});return n.then(t=>{t instanceof IDBCursor&&V.set(t,e)}).catch(()=>{}),M.set(n,e),n}function U(e){if(b.has(e))return;const n=new Promise((t,o)=>{const i=()=>{e.removeEventListener("complete",c),e.removeEventListener("error",r),e.removeEventListener("abort",r)},c=()=>{t(),i()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",c),e.addEventListener("error",r),e.addEventListener("abort",r)});b.set(e,n)}let p={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return b.get(e);if(n==="objectStoreNames")return e.objectStoreNames||A.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return f(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function X(e){p=e(p)}function Y(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(n,...t){const o=e.call(I(this),n,...t);return A.set(o,n.sort?n.sort():[n]),f(o)}:J().includes(e)?function(...n){return e.apply(I(this),n),f(V.get(this))}:function(...n){return f(e.apply(I(this),n))}}function Z(e){return typeof e=="function"?Y(e):(e instanceof IDBTransaction&&U(e),G(e,H())?new Proxy(e,p):e)}function f(e){if(e instanceof IDBRequest)return Q(e);if(y.has(e))return y.get(e);const n=Z(e);return n!==e&&(y.set(e,n),M.set(n,e)),n}const I=e=>M.get(e);function ne(e,n,{blocked:t,upgrade:o,blocking:i,terminated:c}={}){const r=indexedDB.open(e,n),d=f(r);return o&&r.addEventListener("upgradeneeded",s=>{o(f(r.result),s.oldVersion,s.newVersion,f(r.transaction),s)}),t&&r.addEventListener("blocked",s=>t(s.oldVersion,s.newVersion,s)),d.then(s=>{c&&s.addEventListener("close",()=>c()),i&&s.addEventListener("versionchange",a=>i(a.oldVersion,a.newVersion,a))}).catch(()=>{}),d}const _=["get","getKey","getAll","getAllKeys","count"],q=["put","add","delete","clear"],l=new Map;function S(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(l.get(n))return l.get(n);const t=n.replace(/FromIndex$/,""),o=n!==t,i=q.includes(t);if(!(t in(o?IDBIndex:IDBObjectStore).prototype)||!(i||_.includes(t)))return;const c=async function(r,...d){const s=this.transaction(r,i?"readwrite":"readonly");let a=s.store;return o&&(a=a.index(d.shift())),(await Promise.all([a[t](...d),i&&s.done]))[0]};return l.set(n,c),c}X(e=>({...e,get:(n,t,o)=>S(n,t)||e.get(n,t,o),has:(n,t)=>!!S(n,t)||e.has(n,t)}));export{ne as a,ee as o};
